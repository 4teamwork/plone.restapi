#!/bin/bash
#
# CI test that should fail if there are warnings or even errors when building
# the Sphinx docs.

set -euo pipefail

BUILD_LOG="sphinx_build.log"

function red {
    RED=$(tput setaf 1)
    RESET=$(tput sgr0)
    echo "$RED $1 $RESET"
}

bin/sphinxbuilder 2>&1 | tee $BUILD_LOG
BUILD_RETCODE=$?

! grep -q 'WARNING: ' $BUILD_LOG
WARNINGS=$?

if [[ $WARNINGS = 1 || $BUILD_RETCODE = 1 ]]; then
    red "ERROR: There have been warnings or errors when building Sphinx docs!"
    red ""
    red "This probably means these have been introduced by your changes."
    red "Please take the time to check the output of the Sphinx build and"
    red "address these warnings."
    exit 1
else
    exit 0
fi
